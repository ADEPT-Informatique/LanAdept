@model LanAdept.Views.Places.ModelController.FastMap

@{ 
	bool foundMyPlace = false;
	bool userHasPlace = ViewBag.userHaveAPlace;
	var isPlaceReservationStarted = ViewBag.Settings.IsPlaceReservationStarted;
}

<div id="map-container">
	<div id="map">
		@for (int i = 0; i < Model.Height; i++)
		{
			<div class="row">
				@for (int j = 0; j < Model.Width; j++)
				{
					LanAdeptData.Model.Places.Place place = Model.TabPlaces[j, i];
					if (place == null)
					{
						<div class="place place-none">
						</div>
					}
					else {
						string classFirstDiv = "place";
						bool isUserPlace = false;

						if (isPlaceReservationStarted && !place.IsFree)
						{
							if (userHasPlace && LanAdeptCore.Service.ReservationService.IsUserPlace(place))
							{
								isUserPlace = true;
								classFirstDiv += " place-actuelle";
							}
							else if (place.IsOccupied)
							{
								classFirstDiv += " place-occupe";
							}
							else
							{
								classFirstDiv += " place-reserve";
							}
						}

						<div class="@classFirstDiv" id="@place.PlaceID">
							@if (!ViewBag.Settings.IsLanStarted
								&& isPlaceReservationStarted
								&& !userHasPlace
								&& Html.HasActionPermission("Reserver")
								&& place.IsFree)
							{
								<div class="hover" data-toggle="modal" data-target="#ModalReserverPlace" data-trigger="focus" data-place-text="@place" data-place-id="@place.PlaceID">
									@place
								</div>
							}
							else if (isPlaceReservationStarted
								&& !ViewBag.Settings.IsLanStarted
								&& userHasPlace
								&& Html.HasActionPermission("Reserver")
								&& place.IsFree)
							{
								<div class="hover" data-toggle="modal" data-target="#ModalChangerPlace" data-place-text="@place" data-place-id="@place.PlaceID">
									@place
								</div>
							}
							else if (isPlaceReservationStarted
								&& userHasPlace
								&& !foundMyPlace
								&& isUserPlace)
							{
								foundMyPlace = true;
								<div class="hover">
									@Html.AuthorizeActionLink(@place.ToString(), "MaPlace", true)
								</div>
							}
							else
							{
								if (isPlaceReservationStarted && !place.IsFree)
								{
									<a data-toggle="popover" data-content="@place.LastReservation.UserCompleteName" href="javascript:void(0);" data-trigger="focus">
										@place
									</a>
								}
								else
								{
									<div>
										@place
									</div>
								}
							}
						</div>
					}
				}
			</div>
		}
	</div>
</div>
